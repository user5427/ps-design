generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  SUPER_ADMIN
  ADMIN
  USER
}

enum StockChangeType {
  SUPPLY // manual?
  USAGE // automatic on menu item ordered
  ADJUSTMENT // Manual adjustment by the user
  WASTE // Expired, spilled, etc.. can be automatic(past expiration date) or manual
}

model Business {
  id   String @id @default(uuid()) @db.Uuid
  name String

  users        User[]
  productUnits ProductUnit[]
  products     Product[]
  stockChanges StockChange[]

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model User {
  id                      String  @id @default(uuid()) @db.Uuid
  email                   String  @unique
  passwordHash            String
  name                    String
  role                    Role
  isPasswordResetRequired Boolean @default(true)

  businessId    String?        @db.Uuid
  business      Business?      @relation(fields: [businessId], references: [id])
  refreshTokens RefreshToken[]

  createdStockChanges StockChange[]

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([businessId])
}

model RefreshToken {
  id     String @id @default(uuid()) @db.Uuid
  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tokenHash String    @unique
  jti       String    @unique // Keep for rotation safety
  expiresAt DateTime
  revokedAt DateTime?

  ip        String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([jti])
}

// INVENTORY

model ProductUnit {
  id     String  @id @default(uuid()) @db.Uuid
  name   String // Longer name e.g., "Kilograms", "Grams", "Liters"...
  symbol String? // Optional shorter: e.g., "kg", "g", "L"...

  businessId String   @db.Uuid
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  products Product[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([businessId, name])
  @@index([businessId])
}

model Product {
  id          String  @id @default(uuid()) @db.Uuid
  name        String
  description String?
  isDisabled  Boolean @default(false)

  businessId String   @db.Uuid
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  productUnitId String      @db.Uuid
  productUnit   ProductUnit @relation(fields: [productUnitId], references: [id])

  stockChanges StockChange[]
  stockLevel   StockLevel?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([businessId, name])
  @@index([businessId])
  @@index([productUnitId])
}

model StockChange {
  id String @id @default(uuid()) @db.Uuid

  quantity       Decimal         @db.Decimal(12, 3)
  type           StockChangeType
  expirationDate DateTime?       @db.Date

  businessId String   @db.Uuid
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  productId String  @db.Uuid
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdByUserId String? @db.Uuid
  createdBy       User?   @relation(fields: [createdByUserId], references: [id])

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@index([businessId])
  @@index([businessId, productId])
}

model StockLevel {
  id         String @id @default(uuid()) @db.Uuid
  businessId String @db.Uuid

  quantity Decimal @db.Decimal(12, 3)

  productId String  @unique @db.Uuid
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([businessId, productId])
}
